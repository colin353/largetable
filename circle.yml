machine:
  environment:
    PATH: $PATH:/home/ubuntu/.cargo/bin
dependencies:
  cache_directories:
    - "/home/ubuntu/.cargo"
    - "/home/ubuntu/cache"
  override:
    # It's necessary to delete this file, because it rewrites a bunch
    # of URLs that Cargo tries to access, and messes everything up.
    - rm ~/.gitconfig
    - mkdir -p ~/cache
    - mkdir /tmp/largetable
    - circleci/install_protobuf.sh
    - circleci/install_rust.sh
    - circleci/install_kcov.sh
test:
  override:
    - cargo install
    # Synthesize generated files.
    - protoc --rust_out src/generated src/protobuf/dtable.proto
    - ~/.cargo/bin/cargo test --bin largetable-cli
  post:
    # Upload code coverage statement to codecov.io
    - for file in target/debug/largetable*; do mkdir -p "target/cov/$(basename $file)"; kcov --include-pattern=largetable --verify "target/cov/$(basename $file)" "$file"; done
    - bash <(curl -s https://codecov.io/bash)
