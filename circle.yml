machine:
  environment:
    PATH: $PATH:/home/ubuntu/.cargo/bin
dependencies:
  cache_directories:
    - "/home/ubuntu/.cargo"
    - "/home/ubuntu/cache"
  override:
    # It's necessary to delete this file, because it rewrites a bunch
    # of URLs that Cargo tries to access, and messes everything up.
    - rm ~/.gitconfig
    - mkdir -p ~/cache
    - mkdir /tmp/largetable
    - sudo apt-get install libncursesw5-dev
    - circleci/install_protobuf.sh
    - circleci/install_rust.sh
    - circleci/install_kcov.sh
    # This install will fail if we have a valid cache, but that's okay.
    - cargo install protobuf || true
    - protoc --rust_out src/generated src/protobuf/dtable.proto
test:
  override:
    - ~/.cargo/bin/cargo test --bin largetable-cli
    - ~/.cargo/bin/cargo test --bin largetable
    - ~/.cargo/bin/cargo test --lib
  post:
    # Upload code coverage statement to codecov.io
    - rm ./target/debug/largetable*.d || true
    - for file in target/debug/largetable*; do mkdir -p "target/cov/$(basename $file)"; kcov --include-pattern=largetable --verify "target/cov/$(basename $file)" "$file"; done
    - bash <(curl -s https://codecov.io/bash)
